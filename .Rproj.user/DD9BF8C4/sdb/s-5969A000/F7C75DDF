{
    "collab_server" : "",
    "contents" : "library(tidyverse)\nlibrary(COVID19)\nlibrary(padr)\nlibrary(lubridate)\nlibrary(progress)\nlibrary(RcppRoll)\nlibrary(parallel)\nlibrary(data.table)\nlibrary(ggpubr)\nlibrary(usmap)\nlibrary(tsoutliers)\nlibrary(mgcv)\nsource(\"scripts/utils.R\")\n\n\n# Settings & params -------------------------------------------------------\n\ntheme_set(theme_bw(base_size=12))\nmin_date <- as.Date('2020-10-01')\nfilt=TRUE\nforecast_after <- as.Date('2022-03-31')\n\n\n# Countries ---------------------------------------------------------------\n\nUK <- covid19('United Kingdom') %>% as.data.table\nUK[,country:=administrative_area_level_1]\nUK[,region:=country]\nUK <- UK[country %in% countries & date>=min_date]\nUK[,raw_cases:=dfs(confirmed),by=country]\nUK[,new_confirmed:=outlier_detection(raw_cases)]\nUK[,rm:=round(frollmean(new_confirmed,7,align='right'))]\n\nUK[,new_deaths:=dfs(deaths),by=country]\nUK[,deaths_pc:=deaths/population]\n\nUK <- covid19_nbss(UK,filtering = filt) %>% as.data.table\n\n# US holidays -------------------------------------------------------------\n\nthanksgiving <- c(seq(as.Date('2020-11-26'),as.Date('2020-11-27'),by='day'),\n                  seq(as.Date('2021-11-25'),as.Date('2021-11-29'),by='day'))\nchristmas <- as.Date(c('2020-12-25','2020-12-26'))\nny<- seq(as.Date('2021-01-01'),as.Date('2021-01-02'),by='day')\nlbr <- as.Date(c('2021-09-06','2021-09-07'))\nipd <- as.Date(c('2021-10-11','2021-10-12'))\nhlwn <- as.Date(c('2021-10-30','2021-10-31','2021-11-01'))\nus_holidays <- c(thanksgiving,christmas,ny,lbr,ipd,hlwn)\n\n# NYC ----------------------------------------------------\nUS_counties <- covid19(\"United States\",level=3) %>% as.data.table\nUS_counties[,country:=administrative_area_level_1]\nUS_counties[,state:=administrative_area_level_2]\nUS_counties[,county:=administrative_area_level_3]\nUS_counties <- US_counties[!state %in% c('Guam','Northern Mariana Islands','Virgin Islands','American Samoa')]\nUS_counties[,new_confirmed:=dfs(confirmed),by=c('state','county')]\n\nUS_counties[,new_deaths:=dfs(deaths),by=c('state','county')]\nUS_counties[,lbl:=paste(state,county,sep=',')]\n\nNYC <- US_counties[county=='New York City' & date>=min_date]\nNYC[,raw_cases:=new_confirmed] ### raw data\nNYC[,new_confirmed:=outlier_detection(new_confirmed)]\nNYC[,rm:=round(frollmean(new_confirmed,7,align='right'))]\n\n### Missing data on 4/3 and a next-day data dump on 4/4 are outliers\nNYC[date %in% as.Date(c('2022-04-03','2022-04-04')),new_confirmed:=NA]\nNYC[date %in% as.Date('2022-04-03'),rm:=NA]\n\nNYC <- covid19_nbss(NYC,filtering = filt) %>% as.data.table\n\n\n# Combining datasets ----------------------------------------------------------------\n\nuk <- UK[date>as.Date('2022-02-01')]\nuk[,region:='United Kingdom']\nnyc <- NYC[date>as.Date('2022-02-01')]\nnyc[,region:='New York City']\n\nnyc_tot <- nyc\n# nyc <- nyc[date<=forecast_after]\n\nxx <- rbind(uk[,c('date','region','growth_rate','p2.5_growth_rate','p97.5_growth_rate',\n                  'new_confirmed','rm','raw_cases','mean_position','p2.5_position','p97.5_position')],\n            nyc[,c('date','region','growth_rate','p2.5_growth_rate','p97.5_growth_rate',\n                   'new_confirmed','rm','raw_cases','mean_position','p2.5_position','p97.5_position')])\nxx[,region:=factor(region,levels=c('United Kingdom','New York City'))]\n\n\n\n# Outbreak comparison -----------------------------------------------------\n\nxx[,outbreak_start:=date[min(which(growth_rate>0 & date>as.Date('2022-02-14')))],by=region]\nxx[,outbreak_time:=as.numeric(date-outbreak_start)]\n\nggplot(xx[outbreak_time > -10],aes(outbreak_time,growth_rate))+\n  geom_hline(yintercept = 0)+\n  geom_ribbon(aes(ymin=p2.5_growth_rate,ymax=p97.5_growth_rate,fill=region),alpha=0.1)+\n  geom_line(aes(color=region),lwd=2)+\n  scale_color_manual(values=c('black','red'))+\n  scale_fill_manual(values=c('black','red'))+\n  ggtitle('UK & NYC BA.2 Outbreaks, case growth rates')+\n  scale_y_continuous('Case exponential growth rate, r(t)')+\n  scale_x_continuous('Outbreak Time (days since r(t)>0)')+\n  theme(legend.position=c(0.15,0.9))\nggsave('figures/Outbreak_daily_growth_rate_comparison.png',height=8,width=10)\n\n# 7d moving average growth rate estimation --------------------------------\n### Due to changing day-of-week reporting patterns\n### we can't use the default day-of-week adjusted growth rate estimator.\n### Instead, we focus on forecasting the growth rate of the 7-day moving average.\n\n# xx[is.na(new_confirmed),new_confirmed:=0]\n# xx[region==\"New York City\" & date==as.Date('2022-04-03'),rm:=NA] ### an unusual Sunday without reported cases\n# xx[,grm:=nbs(rm,filtering=TRUE,seasonal=FALSE),by=region]\n# xx[,grm_2.5:=nbs(rm,filtering=TRUE,seasonal=FALSE,name = 'p2.5_growth_rate'),by=region]\n# xx[,grm_97.5:=nbs(rm,filtering=TRUE,seasonal=FALSE,name = 'p97.5_growth_rate'),by=region]\n# \n# xx[,outbreak_start_date:=date[min(which(grm>0 & date>as.Date('2022-02-20')))],by=region]\n# xx[,outbreak_time:=as.numeric((date-outbreak_start_date))]\n\n# nyc_out_of_sample[,growth]\n\n# Outbreak r(t) comparison ------------------------------------------------------------\n# \n# \n# grs <- ggplot(xx[outbreak_time > -10],aes(outbreak_time,grm))+\n#   geom_hline(yintercept = 0)+\n#   geom_ribbon(aes(ymin=grm_2.5,ymax=grm_97.5,fill=region),alpha=0.1)+\n#   geom_line(aes(color=region),lwd=2)+\n#   scale_color_manual(values=c('black','red'))+\n#   scale_fill_manual(values=c('black','red'))+\n#   ggtitle('UK & NYC BA.2 Outbreaks, 7d ma growth rates')+\n#   scale_y_continuous('Case exponential growth rate, r(t)')+\n#   scale_x_continuous('Outbreak Time (days since r(t)>0)')+\n#   theme(legend.position=c(0.15,0.9))+\n#   geom_line(data=nyc_out_of_sample,lty=2,col='red',lwd=2)\n# grs\n# ggsave('figures/Outbreak_7dma_growth_rate_comparison.png',height=8,width=10)\n# \n# \n\n# forecasting NYC ---------------------------------------------------------\nnyc <- xx[region=='New York City']\nuk <- xx[region=='United Kingdom']\n\nnyc <- forecast(nyc,uk) %>% glue_ma\n\nmedium_alert_threshold=(200/1e5)*8.4e6/7\n\n\nll <- function(sd,\n               mn=log(nyc[.N,rm]),\n               up=log(nyc[.N,p97.5_rm]),\n               lw=log(nyc[.N,p2.5_rm])){\n  ((up-qnorm(.975,mean=mn,sd=sd))^2+(lw-qnorm(.025,mean=mn,sd=sd))^2) %>% return\n}\n\nsdlog <- optimize(f=ll,interval = c(.1,1e3))$minimum\n\nprob=signif(1-plnorm(medium_alert_threshold,meanlog=log(nyc[.N,rm]),sdlog=sdlog),2)*100\n\n\nggplot(nyc[forecast==TRUE],aes(date,exp(mean_position)))+\n  geom_line(data=nyc[forecast==FALSE],lwd=2,col='red')+\n  geom_line(lwd=2,col='red',lty=2)\n\n\nfc <- ggplot(nyc,aes(date,rm))+\n  geom_line(data=nyc[forecast==FALSE & !is.na(rm)],lwd=2,col='red')+\n  geom_line(data=nyc[forecast==TRUE],lwd=2,lty=2,col='red')+\n  # geom_bar(data=nyc,aes(y=new_confirmed),stat='identity',col='red',fill=rgb(1,0,0,0.3))+\n  geom_ribbon(data=nyc[forecast==TRUE],aes(ymin=p2.5_rm,ymax=p97.5_rm),fill='red',alpha=0.2)+\n  geom_hline(yintercept = medium_alert_threshold,lwd=1)+\n  annotate(geom='text',x=as.Date('2022-03-18'),y=medium_alert_threshold+90,\n           label=\"Medium Alert Level Threshold\",size=6)+\n  scale_y_continuous('New Cases')+\n  annotate(geom='segment',x=as.Date('2022-04-03'),xend=max(nyc_cases$date),y=2620,yend=medium_alert_threshold)+\n  annotate(geom='text',x=as.Date('2022-04-03'),y=2730,\n           label=paste(prob,'% chance of\\n Medium Alert by ',max(nyc_cases$date),sep=''),\n           fill='white',color='black')+\n  geom_point(data=ny_tot_manual,cex=4,color='darkred')+\n  geom_line(data=ny_tot_manual,color='darkred')+\n  ggtitle('NYC Outbreak Forecast: If NYC follows UK trajectory')\n\nggarrange(grs,fc,ncol=2,labels=c(\"A\",'B'))\nggsave('figures/BA2_NYC_forecast.png',height=6,width=15)\n\n\n\n\nnyc_cases[p97.5>medium_alert_threshold,min(date)]\n",
    "created" : 1649350168314.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3788229329",
    "id" : "F7C75DDF",
    "lastKnownWriteTime" : 1649368648,
    "last_content_update" : 1649368648052,
    "path" : "~/COVID/NYC_BA2_dashboard/scripts/BA2_forecast.R",
    "project_path" : "scripts/BA2_forecast.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}